namespace = wreckingpila_exploit_tax_event

country_event = {
    id = wreckingpila_exploit_tax_event.0
	title = "wreckingpila_exploit_tax_event.title"
	desc = "wreckingpila_exploit_tax_event.desc"
	picture = BANKRUPTCY_eventPicture
	is_triggered_only = yes

    immediate = {
        hidden_effect = {
            set_variable = {
                which = exploit_money
                value = 0.00
            }

            set_variable = {
                which = exploit_money_modifier
                value = 0.00
            }

            set_variable = {
                which = province_exploit_money
                value = 0.00
            }

            set_variable = {
                which = province_exploit_money_modifier
                value = 0.00
            }

            every_owned_province = {
                limit = {
                    base_tax = 2
                    NOT = { has_province_modifier = wreckingpila_exploited }
                }

                set_variable = {
                    which = exploit_money
                    value = 0.00
                }
    
                set_variable = {
                    which = exploit_money_modifier
                    value = 0.00
                }
    
                set_variable = {
                    which = province_exploit_money
                    value = 0.00
                }
    
                set_variable = {
                    which = province_exploit_money_modifier
                    value = 0.00
                }    

                # base_tax ducats / year
                export_to_variable = {
                    which = province_exploit_money
                    value = base_tax
                }

                # local_tax_modifier 100% is 1
                export_to_variable = {
                    which = province_exploit_money_modifier
                    value = modifier:local_tax_modifier
                }

                export_to_variable = {
                    which = province_exploit_money_autonomy
                    value = local_autonomy
                }
                
                multiply_variable = {
                    which = province_exploit_money
                    which = province_exploit_money_modifier
                }

                # income = province_tax - (province_tax*autonomy)/100
                multiply_variable = {
                    which = province_exploit_money_autonomy
                    which = province_exploit_money
                }

                divide_variable = {
                    which = province_exploit_money_autonomy
                    value = 100
                }

                subtract_variable = {
                    which = province_exploit_money
                    which = province_exploit_money_autonomy
                }

                change_variable = {
                    which = exploit_money
                    which = province_exploit_money
                }
                
                owner = {
                    change_variable = {
                        which = exploit_money
                        which = PREV
                    }
                }
                
                #log = "WRECKING [This.GetName] has [This.province_exploit_money.GetValue] ducats before modifiers"
                #log = "WRECKING [This.GetName] has [This.province_exploit_money_modifier.GetValue] modifier"
                #log = "WRECKING [This.GetName] has [This.province_exploit_money_autonomy.GetValue] autonomy"
            }
            
            # global_tax_modifier 100% is 0
            export_to_variable = {
                which = exploit_money_modifier
                value = modifier:global_tax_modifier
            }
        
            multiply_variable = {
                which = exploit_money_modifier
                which = exploit_money
            }
        
            change_variable = {
                which = exploit_money
                which = exploit_money_modifier
            }

            multiply_variable = {
                which = exploit_money
                value = 5
            }
        }
    }
	
    option = {
		name = "wreckingpila_exploit_tax_exit"
		ai_chance = { factor = 100 }
	}

    option = {
		name = "wreckingpila_exploit_tax_event.1"
        highlight = yes

        trigger = {
            any_owned_province = {
                base_tax = 2
                NOT = { has_province_modifier = wreckingpila_exploited }
            }
        }

        country_event = {
            id = wreckingpila_exploit_tax_event.90
        }
	}
}

country_event = {
    id = wreckingpila_exploit_tax_event.90
    title = "wreckingpila_exploit_tax_event.90.t"
    desc = "wreckingpila_exploit_tax_event.90.d"
    is_triggered_only = yes
    hidden = yes

    option = {
		name = "wreckingpila_exploit_tax_exit"
		ai_chance = { factor = 100 }
	}

    immediate = {
        hidden_effect = {
            set_variable = {
                which = exploit_money
                value = 0.00
            }

            set_variable = {
                which = exploit_money_modifier
                value = 0.00
            }

            set_variable = {
                which = province_exploit_money
                value = 0.00
            }

            set_variable = {
                which = province_exploit_money_modifier
                value = 0.00
            }

            every_owned_province = {
                limit = {
                    base_tax = 2
                    NOT = { has_province_modifier = wreckingpila_exploited }
                }

                set_variable = {
                    which = exploit_money
                    value = 0.00
                }
    
                set_variable = {
                    which = exploit_money_modifier
                    value = 0.00
                }
    
                set_variable = {
                    which = province_exploit_money
                    value = 0.00
                }
    
                set_variable = {
                    which = province_exploit_money_modifier
                    value = 0.00
                }    

                # base_tax ducats / year
                export_to_variable = {
                    which = province_exploit_money
                    value = base_tax
                }

                # local_tax_modifier 100% is 1
                export_to_variable = {
                    which = province_exploit_money_modifier
                    value = modifier:local_tax_modifier
                }

                export_to_variable = {
                    which = province_exploit_money_autonomy
                    value = local_autonomy
                }
                
                multiply_variable = {
                    which = province_exploit_money
                    which = province_exploit_money_modifier
                }

                # income = province_tax - (province_tax*autonomy)/100
                multiply_variable = {
                    which = province_exploit_money_autonomy
                    which = province_exploit_money
                }

                divide_variable = {
                    which = province_exploit_money_autonomy
                    value = 100
                }

                subtract_variable = {
                    which = province_exploit_money
                    which = province_exploit_money_autonomy
                }

                change_variable = {
                    which = exploit_money
                    which = province_exploit_money
                }
                
                owner = {
                    change_variable = {
                        which = exploit_money
                        which = PREV
                    }
                }
                
                add_permanent_province_modifier = {
                    name = wreckingpila_exploited
                    duration = 7300
                }
        
                add_base_tax = -1

            }
            
            # global_tax_modifier 100% is 0
            export_to_variable = {
                which = exploit_money_modifier
                value = modifier:global_tax_modifier
            }
        
            multiply_variable = {
                which = exploit_money_modifier
                which = exploit_money
            }
        
            change_variable = {
                which = exploit_money
                which = exploit_money_modifier
            }

            multiply_variable = {
                which = exploit_money
                value = 5
            }

            while = {
                limit = {
                    check_variable = {
                        which = exploit_money
                        value = 1
                    }
                }

                add_treasury = 1
        
                subtract_variable = {
                    which = exploit_money
                    value = 1
                }
            }
        
            multiply_variable = {
                which = exploit_money
                value = 100
            }
        
            while = {
                limit = {
                    check_variable = {
                        which = exploit_money
                        value = 1
                    }
                }
        
                add_treasury = 0.01
                
                subtract_variable = {
                    which = exploit_money
                    value = 1
                }
            }
        }
    }
}
